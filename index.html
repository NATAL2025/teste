<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedido de Férias 2026</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: none;
    color: #0f3d2e;
    margin: 0;
    height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 40px;
}
#passwordPrompt, #formContainer {
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(15, 61, 46, 0.2);
    max-width: 400px;
    width: 100%;
    margin-bottom: 20px;
}
label { display: block; margin-bottom: 10px; color: #0f3d2e; }
select, input[type="date"], input[type="password"] {
    padding: 8px; margin-bottom: 15px; width: 100%;
    border: 1px solid #0f3d2e; border-radius: 6px;
    background-color: #f8fdfb; color: #0f3d2e;
}
button {
    padding: 10px 15px; background-color: #0f3d2e; color: white;
    border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;
}
button:hover { background-color: #0c3326; }
.error { color: #a33; margin-top: 10px; display: none; }
.success { color: green; font-weight: bold; margin-top: 15px; }
#detalhesReserva { margin-top: 20px; }
#formContainer { display: none; }
h1, h2 { text-align: center; }
#resumoPedidos div {
    border: 1px solid #0f3d2e;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    background-color: #e6ffec;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="passwordPrompt">
<h1>Pedidos de Férias 2026</h1>
<label for="password">Digite a senha para acessar o formulário:</label>
<input type="password" id="password" required>
<button id="btnEntrar">Entrar</button>
<div id="senhaErro" class="error">Senha incorreta. Tente novamente.</div>
</div>

<!-- FORMULÁRIO -->
<div id="formContainer">
<h1>Pedidos de Férias 2026</h1>

<form id="reservaForm">
<label for="nome">Nome:</label>
<select id="nome" required>
    <option value="Andreia Gralha">Andreia Gralha</option>
    <option value="Telma Rosa">Telma Rosa</option>
</select>

<label for="tipoDias">Tipo de Dias:</label>
<select id="tipoDias" required>
    <option value="Preferenciais">Preferenciais</option>
    <option value="Não Preferenciais">Não Preferenciais</option>
</select>

<label for="dataInicio">Data de Início:</label>
<input type="date" id="dataInicio" required>

<label for="dataFim">Data de Fim:</label>
<input type="date" id="dataFim" required>

<div id="diasCalculados">Dias úteis calculados: 0</div>

<div id="errorMessages" class="error"></div>
<div id="successMessage" class="success"></div>

<button type="submit">Enviar</button>
</form>

<div id="resumoPedidos"></div>
</div>

<script type="module">
// ----- SUPABASE JS -----
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
    'https://bijndfsxrzjviwrdvwms.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk'
);

// ----- FERIADOS -----
const feriados = ['2025-04-25','2025-04-18','2025-05-01'];
const finDeSemana = [0,6];

function isFeriadoOuFimDeSemana(data){
    const diaDaSemana = data.getDay();
    const dataFormatada = data.toISOString().split('T')[0];
    return finDeSemana.includes(diaDaSemana) || feriados.includes(dataFormatada);
}

function calcularDiasEntreDatas(dataInicio,dataFim){
    const start = new Date(dataInicio);
    const end = new Date(dataFim);
    let dias = 0;
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        if(isFeriadoOuFimDeSemana(d)) continue;
        dias++;
    }
    return dias;
}

function atualizarDiasCalculados(){
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const div = document.getElementById('diasCalculados');
    if(dataInicio && dataFim){
        div.innerText = `Dias úteis calculados: ${calcularDiasEntreDatas(dataInicio,dataFim)}`;
    } else div.innerText = 'Dias úteis calculados: 0';
}

document.getElementById('dataInicio').addEventListener('change', atualizarDiasCalculados);
document.getElementById('dataFim').addEventListener('change', atualizarDiasCalculados);

// ----- VERIFICA DATAS DUPLICADAS -----
async function verificarDatasDuplicadas(nome, dataInicio, dataFim){
    try {
        const { data: pedidos, error } = await supabase
            .from('pedidos_ferias')
            .select('data_inicio,data_fim')
            .eq('nome', nome);

        if(error) throw error;

        const inicioNovo = new Date(dataInicio);
        const fimNovo = new Date(dataFim);

        const conflitos = pedidos.filter(pedido => {
            const inicioExistente = new Date(pedido.data_inicio);
            const fimExistente = new Date(pedido.data_fim);
            return inicioNovo <= fimExistente && fimNovo >= inicioExistente;
        });

        return conflitos; // retorna array de pedidos em conflito
    } catch(err){
        console.error("Erro ao verificar datas duplicadas:", err);
        return [];
    }
}

// ----- VERIFICA LIMITE DE DIAS -----
async function verificarLimites(nome, tipoDias, diasNovo){
    const limites = {
        "Andreia Gralha": { "Preferenciais": 5, "Não Preferenciais": 10 },
        "Telma Rosa": { "Preferenciais": 2, "Não Preferenciais": 2 }
    };

    try {
        const { data: pedidos, error } = await supabase
            .from('pedidos_ferias')
            .select('total_dias,tipo_dias')
            .eq('nome', nome)
            .eq('tipo_dias', tipoDias);

        if(error) throw error;

        let diasUsados = pedidos.reduce((sum,p)=>sum+p.total_dias,0);
        let totalDepois = diasUsados + diasNovo;
        let limite = limites[nome][tipoDias];

        if(totalDepois > limite){
            return { pode:false, diasRestantes: limite - diasUsados };
        }
        return { pode:true, diasRestantes: limite - totalDepois };
    } catch(err){
        console.error("Erro ao verificar limites:", err);
        return { pode:true, diasRestantes:null };
    }
}

// ----- ENVIO SUPABASE -----
async function enviarAoSupabase(dados){
    const { data, error } = await supabase.from('pedidos_ferias').insert([dados]);
    if(error) throw error;
    return data;
}

// ----- FORM SUBMIT -----
const form = document.getElementById('reservaForm');

form.addEventListener('submit', async function(event){
    event.preventDefault();

    const nome = document.getElementById('nome').value;
    const tipoDias = document.getElementById('tipoDias').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const totalDias = calcularDiasEntreDatas(dataInicio,dataFim);

    // Verifica datas duplicadas
    const conflitos = await verificarDatasDuplicadas(nome, dataInicio, dataFim);
    if(conflitos.length > 0){
        let msg = conflitos.map(c=>`${c.data_inicio} a ${c.data_fim}`).join(', ');
        document.getElementById('errorMessages').innerText = `❌ Datas em conflito: ${msg}`;
        document.getElementById('successMessage').innerText = '';
        document.getElementById('errorMessages').style.display='block';
        return;
    }

    // Verifica limites
    const limiteCheck = await verificarLimites(nome, tipoDias, totalDias);
    if(!limiteCheck.pode){
        document.getElementById('errorMessages').innerText = `❌ Limite ultrapassado para ${tipoDias}. Restam ${limiteCheck.diasRestantes} dias.`;
        document.getElementById('successMessage').innerText = '';
        document.getElementById('errorMessages').style.display='block';
        return;
    }

    const dados = { nome, tipo_dias: tipoDias, data_inicio: dataInicio, data_fim: dataFim, total_dias: totalDias };

    try{
        await enviarAoSupabase(dados);

        const resumoDiv = document.createElement('div');
        resumoDiv.innerHTML = `
            <strong>Pedido Registrado:</strong><br>
            Nome: ${nome}<br>
            Tipo: ${tipoDias}<br>
            Data Início: ${dataInicio}<br>
            Data Fim: ${dataFim}<br>
            Dias Úteis: ${totalDias}
        `;
        document.getElementById('resumoPedidos').appendChild(resumoDiv);

        document.getElementById('successMessage').innerText = "✔️ Pedido submetido com sucesso!";
        document.getElementById('errorMessages').innerText = '';
        document.getElementById('errorMessages').style.display = 'none';

        form.reset();
        document.getElementById('diasCalculados').innerText = 'Dias úteis calculados: 0';

    } catch(err){
        document.getElementById('errorMessages').innerText = "❌ Erro ao enviar: "+err.message;
        document.getElementById('successMessage').innerText = '';
        document.getElementById('errorMessages').style.display='block';
    }
});

// ----- LOGIN -----
document.getElementById('btnEntrar').addEventListener('click', function(){
    const senha = document.getElementById('password').value;
    const erroDiv = document.getElementById('senhaErro');
    if(senha === "senha123"){
        document.getElementById('passwordPrompt').style.display='none';
        document.getElementById('formContainer').style.display='block';
        erroDiv.style.display='none';
    } else{
        erroDiv.style.display='block';
    }
});
</script>
</body>
</html>
