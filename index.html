
<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedido de Férias 2026</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: none; color: #0f3d2e; margin:0; height:100vh; display:flex; align-items:center; justify-content:center; }
#passwordPrompt, #formContainer { background-color: white; padding: 30px; border-radius: 12px; box-shadow:0 4px 20px rgba(15,61,46,0.2); max-width:400px; width:100%; }
label { display:block; margin-bottom:10px; color:#0f3d2e; }
select, input[type="date"], input[type="password"] { padding:8px; margin-bottom:15px; width:100%; border:1px solid #0f3d2e; border-radius:6px; background-color:#f8fdfb; color:#0f3d2e; }
button { padding:10px 15px; background-color:#0f3d2e; color:white; border:none; border-radius:6px; cursor:pointer; margin-top:10px; }
button:hover { background-color:#0c3326; }
.error { color:#a33; margin-top:10px; }
.success { color:green; font-weight:bold; margin-top:15px; }
#detalhesReserva { margin-top:20px; }
#formContainer { display:none; }
#novoPedidoBtn { background-color:#e6ffec; color:#0f3d2e; border:1px solid #0f3d2e; }
#novoPedidoBtn:hover { background-color:#d1f7dc; }
h1,h2 { text-align:center; }
</style>
</head>
<body>

<div id="passwordPrompt">
<h1>Pedidos de Férias 2026</h1>
<label for="password">Digite a senha para acessar o formulário:</label>
<input type="password" id="password" required>
<button id="loginBtn" type="button">Entrar</button>
<div id="senhaErro" class="error" style="display:none;">Senha incorreta. Tente novamente.</div>
</div>

<div id="formContainer">
<h1>Pedidos de Férias 2026</h1>
<form id="reservaForm">
<label for="nome">Nome:</label>
<select id="nome" required>
<option value="Andreia Gralha">Andreia Gralha</option>
<option value="Telma Rosa">Telma Rosa</option>
</select>
<label for="tipoDias">Tipo de Dias:</label>
<select id="tipoDias" required>
<option value="Preferenciais">Preferenciais</option>
<option value="Não Preferenciais">Não Preferenciais</option>
</select>
<label for="dataInicio">Data de Início:</label>
<input type="date" id="dataInicio" required>
<label for="dataFim">Data de Fim:</label>
<input type="date" id="dataFim" required>
<div id="diasCalculados">Dias úteis calculados: 0</div>
<div id="errorMessages" class="error"></div>
<div id="successMessage" class="success"></div>
<button type="submit">Enviar</button>
</form>
<div id="detalhesReserva"></div>
<button id="novoPedidoBtn" style="display:none;" onclick="novoPedido()">Submeter Novo Pedido</button>
</div>

<script>
// LOGIN FUNCIONAL
document.getElementById('loginBtn').addEventListener('click', function(){
    const senha = document.getElementById('password').value.trim();
    if(senha === 'senha123'){
        document.getElementById('passwordPrompt').style.display='none';
        document.getElementById('formContainer').style.display='block';
        document.getElementById('senhaErro').style.display='none';
    } else {
        document.getElementById('senhaErro').style.display='block';
    }
});

// CALCULO DE DIAS ÚTEIS
const feriados = ['2025-04-25','2025-04-18','2025-05-01'];
const fimDeSemana = [0,6];

function isFeriadoOuFimDeSemana(data){
    const dia = data.getDay();
    const d = data.toISOString().split('T')[0];
    return fimDeSemana.includes(dia) || feriados.includes(d);
}

function calcularDiasEntreDatas(dataInicio,dataFim){
    let dias = 0;
    let start = new Date(dataInicio);
    let end = new Date(dataFim);
    for(let d = new Date(start); d<=end; d.setDate(d.getDate()+1)){
        if(isFeriadoOuFimDeSemana(d)) continue;
        dias++;
    }
    return dias;
}

function atualizarDiasCalculados(){
    const inicio = document.getElementById('dataInicio').value;
    const fim = document.getElementById('dataFim').value;
    if(inicio && fim){
        document.getElementById('diasCalculados').innerText = `Dias úteis calculados: ${calcularDiasEntreDatas(inicio,fim)}`;
    } else {
        document.getElementById('diasCalculados').innerText = 'Dias úteis calculados: 0';
    }
}

document.getElementById('dataInicio').addEventListener('change', atualizarDiasCalculados);
document.getElementById('dataFim').addEventListener('change', atualizarDiasCalculados);

// FUNÇÃO NOVO PEDIDO
function novoPedido(){
    document.getElementById('reservaForm').reset();
    document.getElementById('detalhesReserva').innerHTML='';
    document.getElementById('diasCalculados').innerText='Dias úteis calculados: 0';
    document.getElementById('successMessage').innerText='';
    document.getElementById('errorMessages').innerText='';
    document.getElementById('novoPedidoBtn').style.display='none';
}
</script>

<!-- SUPABASE -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabaseUrl='https://bijndfsxrzjviwrdvwm.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk';
const supabase=createClient(supabaseUrl,supabaseKey);

// SUBMIT FORM
document.getElementById('reservaForm').addEventListener('submit', async function(event){
    event.preventDefault();
    const nome=document.getElementById('nome').value;
    const tipoDias=document.getElementById('tipoDias').value;
    const dataInicio=document.getElementById('dataInicio').value;
    const dataFim=document.getElementById('dataFim').value;
    const totalDias=calcularDiasEntreDatas(dataInicio,dataFim);

    console.log("Enviando para Supabase:", { nome, tipoDias, dataInicio, dataFim, totalDias });

    try{
        // insere no Supabase
        const { data, error } = await supabase.from('pedidos_ferias')
            .insert([{ nome, tipo_dias: tipoDias, data_inicio: dataInicio, data_fim: dataFim, total_dias: totalDias }]);
        console.log("Resultado:", { data, error });

        if(error){
            // Verifica se é conflito de datas
            if(error.code === '23505'){
                document.getElementById('errorMessages').innerText="❌ Já existe um pedido que se sobrepõe com estas datas!";
            } else {
                document.getElementById('errorMessages').innerText="❌ Erro ao enviar: "+error.message;
            }
            document.getElementById('successMessage').innerText="";
            return;
        }

        document.getElementById('errorMessages').innerText="";
        document.getElementById('successMessage').innerText="✔️ Pedido submetido com sucesso!";
        document.getElementById('novoPedidoBtn').style.display='inline-block';

    } catch(e){
        document.getElementById('errorMessages').innerText="❌ Erro ao enviar: "+e.message;
        document.getElementById('successMessage').innerText="";
    }
});
</script>

</body>
</html>
